<!DOCTYPE html>
<html lang="hi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>AK AI VOICE - Free Text to Speech</title>

    <!-- Tailwind (quick CDN) -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />

    <!-- Google AdSense script (replace publisher ID) -->
    <script
      async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX"
      crossorigin="anonymous"
    ></script>

    <style>
      /* small polish for range inputs on mobile */
      input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        height: 8px;
        border-radius: 999px;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #1f2937;
        border-radius: 50%;
      }
    </style>
  </head>

  <body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- HEADER -->
    <header class="bg-blue-700 text-white">
      <div class="max-w-5xl mx-auto px-4 py-6 text-center">
        <h1 class="text-3xl md:text-4xl font-extrabold tracking-wide">AK AI VOICE</h1>
        <p class="mt-1 text-sm text-blue-100">Free Text to Speech — Generate & download audio instantly</p>
      </div>

      <!-- Header ad slot (AdSense) -->
      <div class="max-w-5xl mx-auto px-4 pb-4">
        <ins class="adsbygoogle block mx-auto"
          style="display:block; text-align:center;"
          data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
          data-ad-slot="1234567890"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
      </div>
    </header>

    <!-- MAIN -->
    <main class="flex-grow flex items-center justify-center p-6">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-center mb-2">Text → Speech Converter</h2>
        <p class="text-center text-sm text-gray-500 mb-4">Type text, press Play to listen or Download WAV. Client-side & free.</p>

        <textarea id="ttsText" placeholder="Yahan likhiye apna text..." class="w-full border-2 border-gray-200 rounded p-3 h-40 mb-4 resize-y"></textarea>

        <div class="flex flex-wrap items-center justify-center gap-4 mb-4">
          <div class="flex items-center gap-2">
            <label class="text-sm">Language:</label>
            <select id="voiceSelect" class="p-2 border rounded">
              <option value="en/en-us">English (en-us)</option>
              <option value="hi/hi">Hindi (hi) — if available</option>
            </select>
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm">Pitch:</label>
            <input id="pitch" type="range" min="0" max="100" value="50" />
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm">Speed:</label>
            <input id="speed" type="range" min="80" max="300" value="175" />
          </div>

          <div class="flex items-center gap-2">
            <label class="text-sm">Volume:</label>
            <input id="amplitude" type="range" min="0" max="200" value="100" />
          </div>
        </div>

        <div class="flex flex-wrap items-center justify-center gap-4 mb-3">
          <button id="playBtn" class="px-5 py-3 bg-blue-600 text-white rounded shadow">Play</button>
          <button id="downloadBtn" class="px-6 py-3 bg-green-600 text-white rounded shadow">Download WAV</button>
          <button id="clearBtn" class="px-4 py-3 bg-gray-200 rounded">Clear</button>
        </div>

        <div id="status" class="text-center text-sm text-gray-600 mt-2">Initializing TTS engine...</div>

        <div class="mt-4 text-xs text-gray-500 text-center">
          Note: Download uses meSpeak's rawdata export — if the CDN/build doesn't support it the Download button will show a fallback message but Play will still work.
        </div>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="bg-gray-800 text-gray-200">
      <div class="max-w-5xl mx-auto px-4 py-6 text-center text-sm">
        <p>© <span id="year"></span> AK AI VOICE — All Rights Reserved</p>

        <!-- Footer ad slot (AdSense) -->
        <div class="mt-3">
          <ins class="adsbygoogle block mx-auto"
            style="display:block; text-align:center;"
            data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
            data-ad-slot="9876543210"
            data-ad-format="auto"
            data-full-width-responsive="true"></ins>
          <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>
      </div>
    </footer>

    <!-- meSpeak library -->
    <script src="https://cdn.jsdelivr.net/gh/kripken/mespeak/mespeak.min.js"></script>

    <script>
      // DOM refs
      const textArea = document.getElementById('ttsText');
      const status = document.getElementById('status');
      const pitch = document.getElementById('pitch');
      const speed = document.getElementById('speed');
      const amplitude = document.getElementById('amplitude');
      const playBtn = document.getElementById('playBtn');
      const downloadBtn = document.getElementById('downloadBtn');
      const clearBtn = document.getElementById('clearBtn');
      const voiceSelect = document.getElementById('voiceSelect');
      const yearSpan = document.getElementById('year');
      yearSpan.textContent = new Date().getFullYear();

      // Load meSpeak config from jsDelivr (stable)
      try {
        meSpeak.loadConfig('https://cdn.jsdelivr.net/gh/kripken/mespeak/mespeak_config.json');
      } catch (e) {
        console.warn('Failed to load meSpeak config from CDN.', e);
      }

      // Helper to load the chosen voice (returns Promise)
      function loadVoiceById(id) {
        // id example: "en/en-us" or "hi/hi"
        const path = `https://cdn.jsdelivr.net/gh/kripken/mespeak/voices/${id}.json`;
        return new Promise((resolve, reject) => {
          meSpeak.loadVoice(path, () => resolve(id), (err) => reject(err));
          // Note: meSpeak.loadVoice takes a single callback in some builds — this try covers typical behaviour.
        });
      }

      // Keep track of whether voice is ready
      let currentVoice = voiceSelect.value; // default
      let voiceReady = false;

      async function setVoice(id) {
        status.textContent = 'Loading voice...';
        voiceReady = false;
        try {
          await loadVoiceById(id);
          currentVoice = id;
          voiceReady = true;
          status.textContent = `Voice ready (${id}).`;
        } catch (err) {
          console.warn('Voice load failed for', id, err);
          // fallback: try english en-us if hindi failed
          if (id !== 'en/en-us') {
            status.textContent = `Failed to load "${id}". Falling back to English (en-us).`;
            try {
              await loadVoiceById('en/en-us');
              currentVoice = 'en/en-us';
              voiceReady = true;
              status.textContent = `Voice ready (en-us).`;
              voiceSelect.value = 'en/en-us';
            } catch (e2) {
              console.error('English voice also failed to load.', e2);
              status.textContent = 'Voice failed to load. Check your network.';
              voiceReady = false;
            }
          } else {
            status.textContent = 'Voice failed to load. Check your network.';
            voiceReady = false;
          }
        }
      }

      // Initialize first voice (English)
      setVoice(currentVoice);

      // Change voice when user selects
      voiceSelect.addEventListener('change', (e) => {
        const id = e.target.value;
        setVoice(id);
      });

      // Play function
      playBtn.addEventListener('click', () => {
        if (!voiceReady) {
          alert('Voice not ready yet — please wait a moment.');
          return;
        }
        const text = (textArea.value || '').trim();
        if (!text) {
          alert('Pehle kuch likhiye!');
          return;
        }
        status.textContent = 'Playing...';
        try {
          meSpeak.speak(text, {
            voice: currentVoice,
            amplitude: +amplitude.value,
            pitch: +pitch.value,
            speed: +speed.value,
            callback: () => {
              status.textContent = 'Playback finished.';
            },
          });
        } catch (e) {
          console.error('Playback error:', e);
          status.textContent = 'Playback failed. See console for details.';
        }
      });

      // Clear
      clearBtn.addEventListener('click', () => {
        textArea.value = '';
        status.textContent = '';
      });

      // Download WAV (uses rawdata if available)
      downloadBtn.addEventListener('click', () => {
        if (!voiceReady) {
          alert('Voice not ready yet — please wait.');
          return;
        }
        const text = (textArea.value || '').trim();
        if (!text) {
          alert('Pehle kuch likhiye!');
          return;
        }
        status.textContent = 'Generating audio for download...';
        try {
          const result = meSpeak.speak(text, {
            voice: currentVoice,
            amplitude: +amplitude.value,
            pitch: +pitch.value,
            speed: +speed.value,
            rawdata: 'array',
          });

          if (!result) {
            status.textContent = 'Download not supported in this build/browser. Playback still works.';
            return;
          }

          // result should be an array-like of 16-bit samples
          const samples = (Array.isArray(result) || ArrayBuffer.isView(result)) ? new Int16Array(result) : null;
          if (!samples) {
            status.textContent = 'Unexpected audio data format; cannot build WAV.';
            return;
          }

          const wavBlob = makeWav(samples, 22050);
          const url = URL.createObjectURL(wavBlob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'ak-ai-voice.wav';
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
          status.textContent = 'Download started!';
        } catch (e) {
          console.error('Download error:', e);
          status.textContent = 'Error generating audio for download. See console for details.';
        }
      });

      // Utility: convert Int16 samples to WAV Blob
      function makeWav(samples, sampleRate = 22050) {
        const buffer = samples instanceof Int16Array ? samples : new Int16Array(samples);
        const wavBuffer = new ArrayBuffer(44 + buffer.length * 2);
        const view = new DataView(wavBuffer);

        /* RIFF identifier */
        writeString(view, 0, 'RIFF');
        /* file length */
        view.setUint32(4, 36 + buffer.length * 2, true);
        /* RIFF type */
        writeString(view, 8, 'WAVE');
        /* format chunk identifier */
        writeString(view, 12, 'fmt ');
        /* format chunk length */
        view.setUint32(16, 16, true);
        /* sample format (raw) */
        view.setUint16(20, 1, true);
        /* channel count */
        view.setUint16(22, 1, true);
        /* sample rate */
        view.setUint32(24, sampleRate, true);
        /* byte rate (sampleRate * blockAlign) */
        view.setUint32(28, sampleRate * 2, true);
        /* block align (channel count * bytesPerSample) */
        view.setUint16(32, 2, true);
        /* bits per sample */
        view.setUint16(34, 16, true);
        /* data chunk identifier */
        writeString(view, 36, 'data');
        /* data chunk length */
        view.setUint32(40, buffer.length * 2, true);

        let offset = 44;
        for (let i = 0; i < buffer.length; i++, offset += 2) {
          view.setInt16(offset, buffer[i], true);
        }

        return new Blob([view], { type: 'audio/wav' });
      }

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }
    </script>
  </body>
</html>
